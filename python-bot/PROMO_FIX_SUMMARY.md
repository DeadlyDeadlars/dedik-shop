# Исправление замкнутого круга с промокодами

## Проблема
В боте был замкнутый круг: после ввода промокода "WELCOME" и подтверждения, когда пользователь нажимал "Каталог серверов", бот снова просил ввести промокод вместо показа каталога.

## Причина
Промокоды не сохранялись как активные для пользователя. Каждый раз при нажатии "Каталог серверов" бот "забывал" о введенном промокоде.

## Решение

### 1. Добавлена новая таблица `user_active_promocodes`
```sql
create table if not exists user_active_promocodes (
    id integer primary key autoincrement,
    user_id integer references users(id) on delete cascade,
    promo_code text not null,
    discount_percent integer not null,
    min_amount integer default 0,
    created_at text default (datetime('now'))
);
```

### 2. Изменен обработчик промокодов
- При вводе промокода он теперь сохраняется в таблице `user_active_promocodes`
- Удаляется предыдущий активный промокод пользователя
- Промокод остается активным до использования или очистки

### 3. Изменен обработчик каталога
- Проверяет наличие активного промокода у пользователя
- Показывает информацию об активном промокоде в каталоге
- Пользователь видит, что промокод применен

### 4. Изменен обработчик покупки
- Автоматически применяет активный промокод при выборе тарифа
- Показывает итоговую цену со скидкой
- Проверяет минимальную сумму заказа для промокода

### 5. Добавлен новый обработчик оплаты с промокодом
- `pay_promo:` - для оплаты с автоматическим применением промокода
- Удаляет активный промокод после использования
- Увеличивает счетчик использований промокода

### 6. Добавлена кнопка "Очистить промокод"
- Позволяет пользователю сбросить активный промокод
- Добавлена в основную клавиатуру

## Результат
✅ Замкнутый круг устранен  
✅ Промокоды сохраняются для пользователя  
✅ Каталог показывает активный промокод  
✅ Покупка автоматически применяет промокод  
✅ Добавлена возможность очистки промокода  

## Команды для применения изменений
1. Запустите бота
2. Выполните команду `/init_db` (только для администраторов) для создания новой таблицы
3. Протестируйте работу промокодов

## Тестирование
Запустите `python test_promo_fix.py` для проверки функциональности.
